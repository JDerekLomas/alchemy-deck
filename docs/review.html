<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alchemy Deck - Card Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #1a1612;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      color: #d4af37;
      font-family: 'Cinzel', serif;
      font-size: 1.6rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      margin-bottom: 10px;
    }

    .progress {
      background: #2a2420;
      border-radius: 10px;
      height: 6px;
      margin: 15px 0;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(90deg, #d4af37, #f4cf47);
      height: 100%;
      transition: width 0.3s;
    }

    .progress-text {
      color: #888;
      font-size: 0.85rem;
    }

    .review-area {
      display: flex;
      gap: 50px;
      margin-bottom: 30px;
      align-items: flex-start;
    }

    /* === CARD STYLES === */
    .card-wrapper {
      flex: 0 0 auto;
    }

    .card {
      width: 2.75in;
      height: 4.75in;
      border-radius: 0.125in;
      overflow: hidden;
      background: #0d0a08;
      display: flex;
      flex-direction: column;
      border: 1px solid #3d3530;
      box-shadow: 0 15px 50px rgba(0,0,0,0.6);
      transform: scale(1.35);
      transform-origin: top left;
      margin-bottom: 160px;
      margin-right: 100px;
    }

    .card .artwork {
      height: 2.75in;
      overflow: hidden;
      background: linear-gradient(135deg, #2a2420 0%, #1a1612 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card .artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    .card .text-panel {
      padding: 10px 12px 6px;
      border-top: 2px solid rgba(212, 175, 55, 0.5);
    }

    .card .category {
      font-family: 'Cinzel', serif;
      font-size: 7px;
      font-weight: 600;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-bottom: 3px;
    }

    .card .title {
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      line-height: 1.1;
      letter-spacing: 0.02em;
    }

    .card .subtitle {
      font-family: 'Cormorant Garamond', serif;
      font-size: 11px;
      font-style: italic;
      color: rgba(255,255,255,0.65);
      margin-top: 2px;
      letter-spacing: 0.02em;
    }

    .card .prompt-area {
      padding: 8px 12px;
      font-size: 9.5px;
      line-height: 1.5;
      color: rgba(255,255,255,0.92);
      flex: 1;
      overflow: hidden;
      font-family: 'Cormorant Garamond', serif;
      font-weight: 500;
    }

    .card .quote {
      font-family: 'Cormorant Garamond', serif;
      font-style: italic;
      color: #d4af37;
      font-size: 8px;
      padding: 6px 12px 8px;
      border-top: 1px solid rgba(212, 175, 55, 0.25);
      line-height: 1.35;
      letter-spacing: 0.01em;
    }

    /* Category colors */
    .card.stage .text-panel, .card.stage .prompt-area { background: linear-gradient(to bottom, #2d1f3d, #1f1629); }
    .card.stage .category { color: #c084fc; }
    .card.stage.nigredo .text-panel, .card.stage.nigredo .prompt-area { background: linear-gradient(to bottom, #1a1a1a, #0d0d0d); }
    .card.stage.nigredo .category { color: #666; }
    .card.stage.albedo .text-panel, .card.stage.albedo .prompt-area { background: linear-gradient(to bottom, #3d3d3d, #2a2a2a); }
    .card.stage.albedo .category { color: #e0e0e0; }
    .card.stage.citrinitas .text-panel, .card.stage.citrinitas .prompt-area { background: linear-gradient(to bottom, #4d4020, #3d3018); }
    .card.stage.citrinitas .category { color: #f5c542; }
    .card.stage.rubedo .text-panel, .card.stage.rubedo .prompt-area { background: linear-gradient(to bottom, #4d1a20, #3d1018); }
    .card.stage.rubedo .category { color: #e63946; }

    .card.operation .text-panel, .card.operation .prompt-area { background: linear-gradient(to bottom, #4d2a10, #3d2008); }
    .card.operation .category { color: #ff8c42; }

    .card.element .text-panel, .card.element .prompt-area { background: linear-gradient(to bottom, #1a3d3a, #132d2b); }
    .card.element .category { color: #4ecdc4; }
    .card.element.fire .text-panel, .card.element.fire .prompt-area { background: linear-gradient(to bottom, #4d1a1a, #3d1313); }
    .card.element.fire .category { color: #e63946; }
    .card.element.water .text-panel, .card.element.water .prompt-area { background: linear-gradient(to bottom, #1a2a4d, #132039); }
    .card.element.water .category { color: #457b9d; }
    .card.element.air .text-panel, .card.element.air .prompt-area { background: linear-gradient(to bottom, #2a3d4d, #1f2f3d); }
    .card.element.air .category { color: #a8dadc; }
    .card.element.earth .text-panel, .card.element.earth .prompt-area { background: linear-gradient(to bottom, #2d3d1a, #1f2d13); }
    .card.element.earth .category { color: #606c38; }
    .card.element.quintessence .text-panel, .card.element.quintessence .prompt-area { background: linear-gradient(to bottom, #2d1f4d, #1f1639); }
    .card.element.quintessence .category { color: #6c5ce7; }

    .card.principle .text-panel, .card.principle .prompt-area { background: linear-gradient(to bottom, #4a3d10, #3d3008); }
    .card.principle .category { color: #ffd166; }

    .card.vessel .text-panel, .card.vessel .prompt-area { background: linear-gradient(to bottom, #3d2a1a, #2d1f13); }
    .card.vessel .category { color: #d4a574; }

    .card.sage .text-panel, .card.sage .prompt-area { background: linear-gradient(to bottom, #1a2a3d, #131f2d); }
    .card.sage .category { color: #60a5fa; }

    .card.arcana .text-panel, .card.arcana .prompt-area { background: linear-gradient(to bottom, #3d1a3d, #2d132d); }
    .card.arcana .category { color: #e879f9; }

    /* === RATING PANEL === */
    .rating-panel {
      flex: 1;
      max-width: 580px;
    }

    .rating-section {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .rating-section h3 {
      margin-bottom: 15px;
      color: #d4af37;
      font-family: 'Cinzel', serif;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .rating-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }

    .rating-btn {
      flex: 1;
      padding: 14px;
      border: 2px solid #333;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .rating-btn:hover {
      border-color: #555;
      background: rgba(255,255,255,0.03);
    }

    .rating-btn.selected {
      border-color: #d4af37;
      background: rgba(212, 175, 55, 0.08);
    }

    .rating-btn .emoji { font-size: 1.8rem; }
    .rating-btn .label { color: #777; font-size: 0.75rem; }
    .rating-btn.selected .label { color: #d4af37; }

    .rating-btn.thumbs-up.selected { border-color: #4ade80; background: rgba(74, 222, 128, 0.08); }
    .rating-btn.thumbs-up.selected .label { color: #4ade80; }
    .rating-btn.meh.selected { border-color: #fbbf24; background: rgba(251, 191, 36, 0.08); }
    .rating-btn.meh.selected .label { color: #fbbf24; }
    .rating-btn.thumbs-down.selected { border-color: #f87171; background: rgba(248, 113, 113, 0.08); }
    .rating-btn.thumbs-down.selected .label { color: #f87171; }

    .prompt-section {
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .prompt-section label {
      display: block;
      margin-bottom: 6px;
      color: #777;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .prompt-section .current-prompt {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 0.72rem;
      color: #999;
      line-height: 1.5;
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #eee;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 70px;
    }

    textarea:focus {
      outline: none;
      border-color: #d4af37;
    }

    textarea::placeholder { color: #555; }

    textarea.prompt-edit {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 0.72rem;
    }

    .nav-buttons {
      display: flex;
      gap: 15px;
      justify-content: space-between;
    }

    .nav-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Cinzel', serif;
      font-weight: 500;
    }

    .nav-btn.prev { background: #2a2a2a; color: #ccc; }
    .nav-btn.prev:hover { background: #333; }
    .nav-btn.next {
      background: linear-gradient(135deg, #d4af37, #e5c048);
      color: #1a1a2e;
      font-weight: 600;
    }
    .nav-btn.next:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(212, 175, 55, 0.25);
    }
    .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filter-btn {
      padding: 6px 14px;
      border: 1px solid #333;
      background: transparent;
      color: #777;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .filter-btn.active {
      border-color: #d4af37;
      color: #d4af37;
    }

    .summary-section {
      margin-top: 30px;
      padding: 22px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .summary-section h2 {
      color: #d4af37;
      font-family: 'Cinzel', serif;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 500;
    }

    .summary-stats {
      display: flex;
      gap: 25px;
      margin-bottom: 15px;
    }

    .stat { text-align: center; }
    .stat-number { font-size: 1.6rem; font-weight: bold; }
    .stat-label { color: #777; font-size: 0.8rem; }
    .stat.good .stat-number { color: #4ade80; }
    .stat.meh .stat-number { color: #fbbf24; }
    .stat.bad .stat-number { color: #f87171; }

    .export-btn {
      padding: 11px 22px;
      background: #d4af37;
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Cinzel', serif;
    }

    .keyboard-hint {
      text-align: center;
      color: #555;
      font-size: 0.7rem;
      margin-top: 15px;
    }

    .keyboard-hint kbd {
      background: #2a2a2a;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 0 2px;
    }

    @media (max-width: 1000px) {
      .review-area {
        flex-direction: column;
        align-items: center;
      }
      .card {
        transform: scale(1.25);
        margin-bottom: 100px;
        margin-right: 0;
      }
      .rating-panel {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Alchemy Deck Review</h1>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Card 1 of 34</div>

      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">All (34)</button>
        <button class="filter-btn" data-filter="unreviewed">Unreviewed</button>
        <button class="filter-btn" data-filter="up">Approved</button>
        <button class="filter-btn" data-filter="meh">Needs Work</button>
        <button class="filter-btn" data-filter="down">Rejected</button>
      </div>
    </header>

    <div class="review-area">
      <div class="card-wrapper">
        <div class="card" id="cardElement">
          <div class="artwork">
            <img id="cardImage" src="" alt="">
          </div>
          <div class="text-panel">
            <div class="category" id="cardCategory"></div>
            <div class="title" id="cardTitle"></div>
            <div class="subtitle" id="cardSubtitle"></div>
          </div>
          <div class="prompt-area" id="cardPrompt"></div>
          <div class="quote" id="cardQuote"></div>
        </div>
      </div>

      <div class="rating-panel">
        <div class="rating-section">
          <h3>Rate this card</h3>
          <div class="rating-buttons">
            <button class="rating-btn thumbs-up" data-rating="up">
              <span class="emoji">üëç</span>
              <span class="label">Good to print</span>
            </button>
            <button class="rating-btn meh" data-rating="meh">
              <span class="emoji">üòê</span>
              <span class="label">Needs tweaking</span>
            </button>
            <button class="rating-btn thumbs-down" data-rating="down">
              <span class="emoji">üëé</span>
              <span class="label">Regenerate</span>
            </button>
          </div>

          <div class="prompt-section">
            <label>Current Image Prompt:</label>
            <div class="current-prompt" id="currentPrompt"></div>
          </div>

          <div class="prompt-section">
            <label>Revised Prompt (edit to improve):</label>
            <textarea id="revisedPrompt" class="prompt-edit" placeholder="Edit the prompt to improve the image..."></textarea>
          </div>

          <div class="prompt-section">
            <label>Notes:</label>
            <textarea id="commentInput" placeholder="e.g., 'Image too dark', 'Composition off-center'..."></textarea>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="nav-btn prev" id="prevBtn">‚Üê Previous</button>
          <button class="nav-btn next" id="nextBtn">Next ‚Üí</button>
        </div>

        <div class="keyboard-hint">
          <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> navigate &nbsp; <kbd>1</kbd> approve &nbsp; <kbd>2</kbd> meh &nbsp; <kbd>3</kbd> reject
        </div>
      </div>
    </div>

    <div class="summary-section" id="summarySection" style="display: none;">
      <h2>Review Summary</h2>
      <div class="summary-stats">
        <div class="stat good">
          <div class="stat-number" id="goodCount">0</div>
          <div class="stat-label">Approved</div>
        </div>
        <div class="stat meh">
          <div class="stat-number" id="mehCount">0</div>
          <div class="stat-label">Needs Work</div>
        </div>
        <div class="stat bad">
          <div class="stat-number" id="badCount">0</div>
          <div class="stat-label">Rejected</div>
        </div>
      </div>
      <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="reviewerName" placeholder="Your name" style="padding: 10px 14px; border: 1px solid #333; background: #1a1a1a; color: #eee; border-radius: 6px; font-size: 0.9rem; width: 150px;">
        <button class="export-btn" id="submitBtn">Submit to Sheet</button>
        <button class="export-btn" id="exportBtn" style="background: #2a2a2a; color: #ccc;">Export JSON</button>
      </div>
      <div id="submitStatus" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
      <a href="https://docs.google.com/spreadsheets/d/1MwiJQf8ve1qZxs48rLpREDQC4pJDHF-BCJDVKCdv0UE/edit?usp=sharing" target="_blank" style="display: inline-block; margin-top: 12px; color: #888; font-size: 0.8rem; text-decoration: none;">View all reviews ‚Üí</a>
    </div>
  </div>

  <script>
    const BASE_STYLE = "Detailed alchemical engraving illustration, hand-tinted with muted earth tones and gold accents, copper and sepia coloring, mystical Renaissance style, intricate linework, esoteric symbolism, aged parchment texture, high detail, centered composition, no text or letters";

    // Google Apps Script URL - deploy the script and paste URL here
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQoStMTS_ccBl7ZUQRSCWsj48OPZmZbIrA9y0UKNtzvhuoPFQ5ascoqyZsXqZOGx26/exec';

    // Selected image versions from user review (2026-01-01)
    // v1 = cards-v1/, v2 = cards/, v3 = cards-v3/
    const selectedVersions = {
      "stage-01": "cards",        // v2
      "stage-02": "cards-v3",     // v3
      "stage-03": "cards-v1",     // v1
      "stage-04": "cards",        // v2
      "op-01": "cards-v1",        // v1
      "op-02": "cards-v1",        // v1
      "op-03": "cards",           // v2
      "op-04": "cards-v3",        // v3
      "op-05": "cards",           // v2
      "op-06": "cards",           // v2
      "op-07": "cards",           // v2
      "elem-01": "cards-v1",      // v1
      "elem-02": "cards-v1",      // v1
      "elem-03": "cards",         // v2
      "elem-04": "cards-v1",      // v1
      "elem-05": "cards",         // v2
      "prin-01": "cards",         // v2
      "prin-02": "cards",         // v2
      "prin-03": "cards",         // v2
      "vessel-01": "cards",       // v2
      "vessel-02": "cards",       // v2
      "vessel-03": "cards",       // v2
      "vessel-04": "cards",       // v2
      "sage-01": "cards",         // v2
      "sage-02": "cards",         // v2
      "sage-03": "cards",         // v2
      "sage-04": "cards",         // v2
      "sage-05": "cards-v1",      // v1
      "sage-06": "cards",         // v2
      "arc-01": "cards",          // v2
      "arc-02": "cards",          // v2
      "arc-03": "cards",          // v2
      "arc-04": "cards",          // v2
      "arc-05": "cards"           // v2
    };

    const cards = [
      // STAGES
      {
        id: "stage-01", type: "stage", subtype: "nigredo",
        category: "Stage", title: "Nigredo", subtitle: "Blackening",
        prompt: "The first stage of transformation. Something must die for the new to be born. What needs to end? What shadow are you avoiding? The dark night holds the seed of dawn.",
        quote: '"I am black, white, yellow, and red." ‚ÄîMaier',
        imagePrompt: "Nigredo blackening stage, dark ravens circling a black sun, decomposing matter in vessel, skull and bones, death symbolism, sol niger, dark smoke rising, putrefaction",
        revisedPrompt: "Nigredo stage of the Great Work, seven ravens circling a sol niger (black sun) eclipsing the sky, sealed alchemical vessel containing decomposing prima materia turning black, caput mortuum (death's head) emerging from dark vapors, lead transmuting, midnight atmosphere with no light except the dark sun's corona"
      },
      {
        id: "stage-02", type: "stage", subtype: "albedo",
        category: "Stage", title: "Albedo", subtitle: "Whitening",
        prompt: "Purification after darkness. The impurities wash away, revealing what was hidden beneath. What clarity is emerging? What false beliefs are dissolving?",
        quote: '"Water purifies all imperfect things." ‚ÄîSendivogius',
        imagePrompt: "Albedo whitening stage, white dove emerging, silver moon, purified white substance in glass vessel, pearl, snow white rose, washing waters, lunar symbolism",
        revisedPrompt: "Albedo whitening stage, white dove (columba) ascending from dark waters, full silver moon reflected in purifying bath, sealed vessel containing brilliant white powder like fresh snow, white queen emerging, dew drops on white roses, mercurial waters washing the blackened matter to silver-white purity"
      },
      {
        id: "stage-03", type: "stage", subtype: "citrinitas",
        category: "Stage", title: "Citrinitas", subtitle: "Yellowing",
        prompt: "Solar consciousness awakens. After purification comes illumination‚Äîthe first glimpse of wisdom. What insight is breaking through? What understanding is dawning?",
        quote: '"The vulture cries: I am white and black, yellow and red." ‚ÄîMaier',
        imagePrompt: "Citrinitas yellowing stage, golden dawn breaking, solar rays piercing clouds, yellow sulfur, sunrise over alchemical landscape, awakening light, vulture on mountain summit",
        revisedPrompt: "Citrinitas yellowing stage from Maier's Atalanta Fugiens, vulture perched on mountain summit crying at dawn, white matter in vessel turning golden yellow, sulfurous vapors rising, first rays of solar gold breaking over alchemical landscape, aurora consurgens (rising dawn), the wise awakening"
      },
      {
        id: "stage-04", type: "stage", subtype: "rubedo",
        category: "Stage", title: "Rubedo", subtitle: "Reddening",
        prompt: "The Great Work complete. Opposites unite, the self becomes whole. Integration of all that was separated. What would wholeness look like here? What is ready to be complete?",
        quote: '"The fixed becomes volatile; the volatile, fixed." ‚ÄîKhunrath',
        imagePrompt: "Rubedo reddening stage, phoenix rising from flames, red philosopher's stone, sacred marriage of sun and moon, royal wedding, red rose, blood red elixir, completion",
        revisedPrompt: "Rubedo reddening completion stage, phoenix reborn from alchemical flames, glowing red philosopher's stone (lapis philosophorum) in sealed vessel, sacred marriage (coniunctio) of Sol and Luna as crowned king and queen embracing, red rose in full bloom, blood-red elixir dripping, the Great Work achieved"
      },

      // OPERATIONS
      {
        id: "op-01", type: "operation",
        category: "Operation", title: "Calcination", subtitle: "Burning",
        prompt: "Reduction by fire. Ego attachments, false identities, outdated beliefs‚Äîall fuel for the flames. What must be burned away? What are you clinging to that no longer serves?",
        quote: '"All impurities are purified by fire." ‚ÄîSendivogius',
        imagePrompt: "Calcination operation, fierce flames consuming matter, white ash in crucible, salamander in fire, burning away impurities, reduction by fire, glowing embers",
        revisedPrompt: "Calcination operation, fierce elemental fire consuming base matter in iron crucible, salamander spirit dancing in flames unharmed, white calcium ash forming at bottom, impurities burning away as dark smoke, the first operation of the seven, purification through destruction"
      },
      {
        id: "op-02", type: "operation",
        category: "Operation", title: "Dissolution", subtitle: "Dissolving",
        prompt: "Letting go into the waters. Rigid structures soften, defenses melt, emotions finally flow. Where are you holding too tightly? What needs to be released into feeling?",
        quote: '"Water joins together everything dissolved." ‚ÄîSendivogius',
        imagePrompt: "Dissolution operation, matter dissolving in dark water, tears and rain, moon reflected in pool, sea serpent, watery depths, melting forms, emotional release",
        revisedPrompt: "Dissolution operation, calcined ash dissolving in mercurial waters within a sealed glass vessel, silver moon reflected in the dark solution, undine water spirit in the depths, rigid forms melting and softening, tears of dew falling, the second operation of surrender"
      },
      {
        id: "op-03", type: "operation",
        category: "Operation", title: "Separation", subtitle: "Discerning",
        prompt: "Sorting the essential from the inessential. Not all that dissolved belongs together. What serves your growth? What must be left behind? Discernment is the blade.",
        quote: '"Fire separates everything that is joined." ‚ÄîSendivogius',
        imagePrompt: "Separation operation, sword dividing light and darkness, eagle ascending toad descending, filtering pure from impure, wheat from chaff, scales of discernment",
        revisedPrompt: "Separation operation, flaming sword of discernment dividing light from darkness, white eagle of spirit ascending while black toad of matter descends, filter separating pure quintessence from dross, balanced scales weighing essence, the third operation of wisdom"
      },
      {
        id: "op-04", type: "operation",
        category: "Operation", title: "Conjunction", subtitle: "Uniting",
        prompt: "The sacred marriage within. What was separated now reunites at a higher level. Masculine and feminine, light and shadow, mind and heart. What opposites in you seek union?",
        quote: '"The animated spirit is joined to the body." ‚ÄîKhunrath',
        imagePrompt: "Conjunction operation, sacred marriage of king and queen, sun and moon joining, hermaphrodite rebis, chemical wedding, two becoming one, embrace of opposites",
        revisedPrompt: "Conjunction operation from Khunrath's Amphitheater, sacred chemical wedding of Red King (sulphur) and White Queen (mercury), Sol and Luna embracing within sealed vessel, hermaphroditic rebis forming from their union, roses and lilies intertwined, the fourth operation of sacred marriage"
      },
      {
        id: "op-05", type: "operation",
        category: "Operation", title: "Fermentation", subtitle: "Inspiring",
        prompt: "New life from decay. The breakdown creates conditions for breakthrough. Crisis becomes catalyst. What is fermenting in you? What inspiration is arising from difficulty?",
        quote: '"Nature gives motion, motion excites fire." ‚ÄîSendivogius',
        imagePrompt: "Fermentation operation, peacock tail cauda pavonis, iridescent colors, rotting matter birthing new life, bubbling ferment, yeast and transformation, inspiration arising",
        revisedPrompt: "Fermentation operation, cauda pavonis (peacock's tail) displaying iridescent rainbow colors in the vessel, rotting matter giving birth to new golden growth, bubbling ferment with rising vapors, inspiration breaking through decay, the fifth operation of spiritual rebirth"
      },
      {
        id: "op-06", type: "operation",
        category: "Operation", title: "Distillation", subtitle: "Refining",
        prompt: "Repeated cycles of purification. Rise, condense, return, rise again. Each pass extracts more essence. What needs further refinement? What truth is becoming clearer?",
        quote: '"The tincture represents the Soul." ‚ÄîDrebbel',
        imagePrompt: "Distillation operation, alembic with rising vapors, condensing drops, eagle ascending, dew collecting, copper still, purified essence, repeated refinement cycles",
        revisedPrompt: "Distillation operation from Drebbel's Treatises, elegant glass alembic with spiraling vapors rising, pure essence condensing as golden drops in the beak, white eagle of volatile spirit ascending, morning dew collecting, the sixth operation of repeated refinement until only pure tincture remains"
      },
      {
        id: "op-07", type: "operation",
        category: "Operation", title: "Coagulation", subtitle: "Manifesting",
        prompt: "Spirit takes form. The refined essence crystallizes into reality. Insight becomes action, vision becomes creation. What is ready to manifest? How does this become real?",
        quote: '"Let it slowly coagulate in a warm place." ‚ÄîDrebbel',
        imagePrompt: "Coagulation operation, philosopher's stone forming, crystallization process, solid gold emerging, phoenix egg, manifested perfection, spirit becoming matter",
        revisedPrompt: "Coagulation operation, philosopher's stone crystallizing from purified tincture in warm athanor, ruby red lapis forming geometric structure, solid gold precipitating from solution, phoenix egg ready to hatch, the seventh and final operation where spirit becomes perfected matter"
      },

      // ELEMENTS
      {
        id: "elem-01", type: "element", subtype: "fire",
        category: "Element", title: "Fire", subtitle: "Will",
        prompt: "The principle of transformation and will. Fire purifies, energizes, and destroys what cannot withstand truth. Where do you need more fire? What requires decisive action?",
        quote: '"Fire acts in wonderful hidden ways." ‚ÄîSendivogius',
        imagePrompt: "Elemental fire, roaring flames, salamander spirit dancing in fire, upward triangle symbol, solar rays, burning torch, volcanic power, transformative heat",
        revisedPrompt: "Elemental Fire from Sendivogius, roaring alchemical flames in upward-pointing triangle, salamander spirit unharmed within the blaze, solar rays emanating from burning heart, volcanic transformative power, the active masculine principle that purifies and transmutes all it touches"
      },
      {
        id: "elem-02", type: "element", subtype: "water",
        category: "Element", title: "Water", subtitle: "Emotion",
        prompt: "The principle of feeling and intuition. Water dissolves, cleanses, and connects. It flows around obstacles and finds the lowest places. What emotions need honoring? What seeks to flow?",
        quote: '"Water purifies all imperfect things." ‚ÄîSendivogius',
        imagePrompt: "Elemental water, flowing streams, undine water spirit, downward triangle symbol, lunar tides, fish and waves, dissolving waters, emotional depths",
        revisedPrompt: "Elemental Water from Sendivogius, mercurial waters flowing within downward-pointing triangle, undine spirit swimming in lunar-lit depths, silver moon governing the tides, fish and serpents in dissolving currents, the receptive feminine principle that purifies and joins all things"
      },
      {
        id: "elem-03", type: "element", subtype: "air",
        category: "Element", title: "Air", subtitle: "Thought",
        prompt: "The principle of mind and communication. Air carries words, ideas, and breath itself. It moves between all things. What needs to be said? What thoughts seek expression?",
        quote: '"Motion excites air, air excites fire." ‚ÄîSendivogius',
        imagePrompt: "Elemental air, swirling winds, sylph air spirits, birds in flight, clouds and sky, breath of life, intellectual clarity, feathers floating",
        revisedPrompt: "Elemental Air from Sendivogius, swirling philosophical winds within triangle with horizontal line, sylph spirits soaring among clouds, eagles and doves in flight, breath of life spiritus carrying thoughts, the mediating principle between fire above and water below"
      },
      {
        id: "elem-04", type: "element", subtype: "earth",
        category: "Element", title: "Earth", subtitle: "Body",
        prompt: "The principle of matter and manifestation. Earth grounds, stabilizes, and gives form. It is the body, the material world, what can be touched. What is the physical reality here? What needs grounding?",
        quote: '"Earth receives the Tincture." ‚ÄîSendivogius',
        imagePrompt: "Elemental earth, mountains and caves, gnome earth spirit, crystals growing, roots and stones, fertile soil, material foundation, underground treasures",
        revisedPrompt: "Elemental Earth from Sendivogius, inverted triangle with horizontal line, gnome spirit guarding underground treasures, crystals growing from fertile soil, mountain caves with precious stones, deep roots in black earth, the fixed principle that receives and embodies the tincture"
      },
      {
        id: "elem-05", type: "element", subtype: "quintessence",
        category: "Element", title: "Quintessence", subtitle: "Spirit",
        prompt: "The fifth element, beyond the four. The eternal essence that animates all matter, unchanged by transformation. What is the spiritual dimension here? What transcends the situation?",
        quote: '"The Quintessence is eternal, immutable." ‚ÄîDrebbel',
        imagePrompt: "Fifth element quintessence, starry cosmos, spiraling galaxy, divine celestial light, ethereal spirit, transcendent essence, celestial sphere, stars within",
        revisedPrompt: "Quintessence fifth element from Drebbel's Treatises, eternal immutable essence beyond the four elements, spiraling celestial sphere with fixed stars, divine light radiating from center, the invincible heaven that animates all matter, ethereal spirit untouched by earthly transformation"
      },

      // PRINCIPLES
      {
        id: "prin-01", type: "principle",
        category: "Principle", title: "Sulphur", subtitle: "Soul",
        prompt: "The combustible principle‚Äîwhat burns, desires, and animates. The soul's fire, the driving force within. What does your soul truly want here? What gives this situation its life?",
        quote: '"Sulphur, Salt, Mercury‚Äîthe three called Prima Materia." ‚ÄîParacelsus',
        imagePrompt: "Alchemical sulphur principle, burning sun, solar king with golden flames, combustible spirit, active masculine force, lion, fiery soul essence",
        revisedPrompt: "Alchemical Sulphur from Paracelsus, the combustible soul principle, Red King crowned with solar flames, golden lion breathing fire, burning sun with rays, the active masculine force that gives life and desire to all matter, one of three Prima Materia"
      },
      {
        id: "prin-02", type: "principle",
        category: "Principle", title: "Mercury", subtitle: "Spirit",
        prompt: "The volatile principle‚Äîwhat moves, mediates, and transforms. The messenger between realms, ever-changing quicksilver. What is in flux? What message is trying to get through?",
        quote: '"From living quicksilver comes the prima materia." ‚ÄîRosicrucian MS',
        imagePrompt: "Alchemical mercury principle, winged messenger Hermes, caduceus staff with serpents, quicksilver flowing, volatile spirit, hermaphrodite, mediating force",
        revisedPrompt: "Alchemical Mercury from Rosicrucian tradition, the volatile spirit principle, winged Hermes-Mercurius with caduceus of intertwined serpents, living quicksilver flowing and transforming, hermaphroditic figure mediating between sulphur and salt, the ever-changing messenger between realms"
      },
      {
        id: "prin-03", type: "principle",
        category: "Principle", title: "Salt", subtitle: "Body",
        prompt: "The fixed principle‚Äîwhat remains, preserves, and gives form. The body that contains soul and spirit. What is the structure here? What form is this taking?",
        quote: '"The Sun is fire, salt, and base." ‚ÄîParacelsus',
        imagePrompt: "Alchemical salt principle, crystalline white cube, fixed body form, salt crystals, foundation stone, preserved matter, cubic structure, material base",
        revisedPrompt: "Alchemical Salt from Paracelsus, the fixed body principle, perfect white crystalline cube, salt crystals forming geometric patterns, foundation stone that preserves form, the feminine receptive base that contains volatile spirit and burning soul, one of three Prima Materia"
      },

      // VESSELS
      {
        id: "vessel-01", type: "vessel",
        category: "Vessel", title: "Athanor", subtitle: "The Furnace",
        prompt: "The furnace of slow, steady heat. Transformation requires sustained warmth over time, not quick flames. What requires your patient, consistent attention? Where is patience the path?",
        quote: '"With one Athanor furnace; and one fire." ‚ÄîKhunrath',
        imagePrompt: "Alchemical athanor furnace, tower brick oven, steady patient flame, philosophical egg vessel inside, constant gentle heat, tower furnace design",
        revisedPrompt: "Alchemical Athanor from Khunrath's Amphitheater, tower furnace of brick with steady gentle flame, philosophical egg (vas hermeticum) sealed within maintaining constant heat, patient slow fire for the Great Work, one furnace and one fire as the masters taught"
      },
      {
        id: "vessel-02", type: "vessel",
        category: "Vessel", title: "Alembic", subtitle: "The Still",
        prompt: "The vessel of distillation. Vapors rise, condense, and the essence is collected drop by drop. What needs to be distilled from this situation? What is the essential truth?",
        quote: '"Extract tincture from the cucurbit." ‚ÄîDrebbel',
        imagePrompt: "Alchemical alembic still, elegant glass apparatus, curved condensing head, vapor rising and falling, drops of essence collecting, copper and glass still",
        revisedPrompt: "Alchemical Alembic from Drebbel's Treatises, elegant glass still with cucurbit base and curved helm (capitellum), vapors spiraling upward then condensing, pure tincture collecting drop by golden drop in receiver, copper and glass construction, the vessel of distillation"
      },
      {
        id: "vessel-03", type: "vessel",
        category: "Vessel", title: "Crucible", subtitle: "The Test",
        prompt: "The vessel of trial by fire. Here matter is tested and proved. Only what is genuine survives. What is being tested? What will remain when the fire has done its work?",
        quote: '"The body dies, turns black, reduced to ashes." ‚ÄîKhunrath',
        imagePrompt: "Alchemical crucible, ceramic pot glowing red-hot, fierce flames, molten contents, trial by fire, testing vessel, transformation under heat",
        revisedPrompt: "Alchemical Crucible from Khunrath, ceramic vessel glowing red-white in fierce flames, matter being tested and proved, body corrupted and reduced to precious ash, trial by fire revealing true nature, the testing vessel where only genuine gold survives"
      },
      {
        id: "vessel-04", type: "vessel",
        category: "Vessel", title: "Retort", subtitle: "The Return",
        prompt: "The vessel of circulation. What rises must return to the body, again and again, each cycle deepening the work. What keeps returning? What pattern needs completing?",
        quote: '"It begins where it ends." ‚ÄîHermes',
        imagePrompt: "Alchemical retort vessel, bent-neck flask, pelican vessel feeding young, circulating vapors, philosophical circulation, return to source, ouroboric process",
        revisedPrompt: "Alchemical Retort and Pelican vessel from Hermetic tradition, bent-neck flask returning condensed vapors to the body, pelican feeding its young with its own blood, philosophical circulation where it begins where it ends, ouroboric process of eternal return and refinement"
      },

      // SAGES
      {
        id: "sage-01", type: "sage",
        category: "Sage", title: "Hermes", subtitle: "Trismegistus",
        prompt: "As above, so below. The legendary founder of alchemy taught that the macrocosm mirrors the microcosm. What pattern in your life reflects a larger truth? What correspondence do you see?",
        quote: '"Man bore the image of his father." ‚ÄîPymander',
        imagePrompt: "Hermes Trismegistus, Egyptian-Greek sage with ibis head, emerald tablet, pyramids, caduceus staff, thrice-great master, as above so below gesture",
        revisedPrompt: "Hermes Trismegistus Thrice-Great from the Pymander, Egyptian-Greek sage holding the Emerald Tablet inscribed with secret wisdom, caduceus staff with twin serpents, pyramids at dawn behind, ibis of Thoth, the artisan mind containing the circles, as above so below gesture"
      },
      {
        id: "sage-02", type: "sage",
        category: "Sage", title: "Paracelsus", subtitle: "The Physician",
        prompt: "Nature is the teacher; experience over authority. The radical physician sought the medicine hidden in nature and the disease. What is the medicine here? What does direct experience teach?",
        quote: '"These three are Prima Materia, like God." ‚ÄîParacelsus',
        imagePrompt: "Paracelsus physician alchemist, Renaissance doctor, sword Azoth, medical herbs and vessels, natural philosophy, wild beard, healing arts laboratory",
        revisedPrompt: "Paracelsus the physician-alchemist from Book of Meteors, Renaissance doctor with wild beard holding sword Azoth, surrounded by medicinal herbs and spagyric vessels, three principles (sulphur salt mercury) displayed, the radical reformer who learned from nature not books"
      },
      {
        id: "sage-03", type: "sage",
        category: "Sage", title: "Boehme", subtitle: "The Mystic",
        prompt: "The divine spark in ordinary life. A shoemaker's mystical vision revealed spirit hidden in matter. Where is the sacred in your everyday? What vision might break through?",
        quote: '"Heaven is the Sea of Fire, from the 7 Spirits." ‚ÄîAurora',
        imagePrompt: "Jacob Boehme mystic, humble shoemaker with divine vision, aurora dawn light breaking through, mystical eye, theosophical symbols, spiritual illumination",
        revisedPrompt: "Jacob Boehme the shoemaker-mystic from Aurora, humble craftsman with tools as divine vision breaks through, seven spirits of God radiating, the Sea of Fire forming the Firmament above, mystical eye seeing spiritual foundations, theosophical dawn light illuminating ordinary life"
      },
      {
        id: "sage-04", type: "sage",
        category: "Sage", title: "Ficino", subtitle: "The Translator",
        prompt: "Beauty leads the soul upward. The philosopher who revived Hermes taught that love of beauty opens the path to wisdom. What beauty is calling you? Where does love lead?",
        quote: '"Hermes attempted to eradicate this stain from souls." ‚ÄîOn Pleasure',
        imagePrompt: "Marsilio Ficino, Florentine philosopher translating by candlelight, ancient Greek texts, lyre instrument, platonic academy, Renaissance humanism, beauty and soul",
        revisedPrompt: "Marsilio Ficino from On Pleasure, Florentine philosopher translating Hermetic texts by candlelight, orphic lyre beside him, Platonic Academy gathering, ancient Greek manuscripts spread on desk, beauty leading the soul upward, Renaissance wisdom reviving the prisca theologia"
      },
      {
        id: "sage-05", type: "sage",
        category: "Sage", title: "Sendivogius", subtitle: "The Adept",
        prompt: "Work with nature, not against it. The practical adept taught that nature's secret fire works in hidden ways. What is the natural path forward? What does practical wisdom suggest?",
        quote: '"Fire acts in wonderful hidden ways." ‚ÄîNew Chemical Light',
        imagePrompt: "Michael Sendivogius, Polish alchemist in laboratory, practical apparatus, new chemical light rays, philosophical mercury, adept in scholarly robes",
        revisedPrompt: "Michael Sendivogius from New Chemical Light, Polish adept in practical laboratory with working apparatus, rays of new chemical light revealing nature's secret fire, philosophical mercury in sealed vessel, the practical wisdom of working with nature's hidden ways"
      },
      {
        id: "sage-06", type: "sage",
        category: "Sage", title: "Agrippa", subtitle: "The Magus",
        prompt: "Hidden correspondences connect all things. The magus mapped the occult virtues linking stars, stones, plants, and souls. What hidden connections are at work here? What influences this situation?",
        quote: '"God impresses the seal of Ideas upon Intelligences." ‚ÄîOccult Philosophy',
        imagePrompt: "Cornelius Agrippa, occult philosopher, three books open, pentagram, celestial correspondences diagram, hidden wisdom, magical arts, starry ceiling",
        revisedPrompt: "Cornelius Agrippa from Three Books of Occult Philosophy, the magus mapping celestial correspondences, three volumes open showing elemental celestial and divine worlds, pentagram and planetary seals, God impressing Ideas upon the Intelligences, stars and their virtues reflected below"
      },

      // ARCANA
      {
        id: "arc-01", type: "arcana",
        category: "Arcana", title: "Prima Materia", subtitle: "First Matter",
        prompt: "The raw material before the work begins. Chaos, potential, the formless substance from which all emerges. What is the starting point here? What raw potential awaits transformation?",
        quote: '"The Prima Materia is a divine mist." ‚ÄîHellwig',
        imagePrompt: "Prima materia first matter, chaotic void, cosmic egg in dark waters, unformed potential, primordial chaos, divine mist, creation beginning, formless substance",
        revisedPrompt: "Prima Materia from Hellwig's Curious Physics, divine mist issuing from God's Paradise, cosmic egg floating in dark waters of chaos, formless potential before the Work begins, heavenly waters coagulating into first matter, the raw substance from which all transformation emerges"
      },
      {
        id: "arc-02", type: "arcana",
        category: "Arcana", title: "Lapis", subtitle: "The Stone",
        prompt: "The goal of the Great Work. The perfected self that transforms everything it touches. Not an end state but a living process. What does completion mean here? What would the perfected outcome look like?",
        quote: '"He is praised in the Emerald Tablet... the living fire." ‚ÄîHellwig',
        imagePrompt: "Philosopher's stone lapis, radiant glowing red ruby, inner fire, transmutation power, perfect gem, golden light emanating, completed great work",
        revisedPrompt: "Lapis Philosophorum from Hellwig, the Philosopher's Stone praised in the Emerald Tablet, radiant ruby-red gem containing living fire, transmuting base metals to gold by its presence, the completed Great Work emanating golden light, perfected matter that heals and transforms all it touches"
      },
      {
        id: "arc-03", type: "arcana",
        category: "Arcana", title: "Ouroboros", subtitle: "Eternal Return",
        prompt: "The serpent eating its tail. Endings become beginnings, destruction feeds creation. The cycle completes itself. What cycle is ending and beginning? What renews itself through apparent death?",
        quote: '"It begins where it ends." ‚ÄîHermes',
        imagePrompt: "Ouroboros serpent dragon, eating its own tail, eternal cycle, infinity symbol, scales light to dark, self-renewal, cosmic snake, beginning and end united",
        revisedPrompt: "Ouroboros from Hermetic tradition, great serpent-dragon devouring its own tail, scales transitioning from light to dark around the circle, eternal cycle of death and rebirth, it always begins where it ends, self-sustaining transformation, the alpha and omega united in one symbol"
      },
      {
        id: "arc-04", type: "arcana",
        category: "Arcana", title: "Rebis", subtitle: "The Double",
        prompt: "The union of opposites in one being. Not compromise but integration at a higher level‚Äîboth/and rather than either/or. What dualities in you seek reconciliation? What would integration look like?",
        quote: '"Man bore the image of his father." ‚ÄîPymander',
        imagePrompt: "Rebis hermaphrodite, two-headed figure, sun and moon crowns, male and female merged, perfect union of opposites, alchemical androgyne, dual nature united",
        revisedPrompt: "Rebis the Double Thing from Pymander, hermaphroditic figure with two heads, Sol crowning the male side and Luna the female, masculine and feminine perfectly merged in one body, the alchemical androgyne born from the chemical wedding, man bearing the image of the father who contains all"
      },
      {
        id: "arc-05", type: "arcana",
        category: "Arcana", title: "Elixir", subtitle: "The Medicine",
        prompt: "The universal medicine that heals all ills. Not a substance but a state‚Äîthe perfected tincture that restores wholeness. What healing is needed? What would restore balance here?",
        quote: '"The tincture heals all diseases... represents the Soul." ‚ÄîDrebbel',
        imagePrompt: "Elixir of life, golden glowing liquid in crystal vessel, universal medicine panacea, healing light, immortality potion, perfected tincture, aurum potabile",
        revisedPrompt: "Elixir of Life from Drebbel's Treatises, the tincture that heals all diseases representing the Soul, golden aurum potabile (drinkable gold) glowing in crystal vessel, universal medicine panacea emanating healing light, the perfected liquid stone that restores body and soul to wholeness"
      }
    ];

    let currentIndex = 0;
    let currentFilter = 'all';
    let filteredCards = [...cards];
    let reviews = JSON.parse(localStorage.getItem('alchemyDeckReviews') || '{}');

    const cardElement = document.getElementById('cardElement');
    const cardImage = document.getElementById('cardImage');
    const cardCategory = document.getElementById('cardCategory');
    const cardTitle = document.getElementById('cardTitle');
    const cardSubtitle = document.getElementById('cardSubtitle');
    const cardPrompt = document.getElementById('cardPrompt');
    const cardQuote = document.getElementById('cardQuote');
    const currentPromptEl = document.getElementById('currentPrompt');
    const revisedPromptEl = document.getElementById('revisedPrompt');
    const commentInput = document.getElementById('commentInput');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const summarySection = document.getElementById('summarySection');

    function applyFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });

      if (filter === 'all') filteredCards = [...cards];
      else if (filter === 'unreviewed') filteredCards = cards.filter(c => !reviews[c.id]?.rating);
      else filteredCards = cards.filter(c => reviews[c.id]?.rating === filter);

      currentIndex = 0;
      updateDisplay();
      updateFilterCounts();
    }

    function updateFilterCounts() {
      const counts = {
        all: cards.length,
        unreviewed: cards.filter(c => !reviews[c.id]?.rating).length,
        up: cards.filter(c => reviews[c.id]?.rating === 'up').length,
        meh: cards.filter(c => reviews[c.id]?.rating === 'meh').length,
        down: cards.filter(c => reviews[c.id]?.rating === 'down').length
      };
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const filter = btn.dataset.filter;
        const label = filter === 'all' ? 'All' : filter === 'unreviewed' ? 'Unreviewed' : filter === 'up' ? 'Approved' : filter === 'meh' ? 'Needs Work' : 'Rejected';
        btn.textContent = `${label} (${counts[filter]})`;
      });
    }

    function updateDisplay() {
      if (filteredCards.length === 0) {
        cardImage.src = '';
        cardCategory.textContent = '';
        cardTitle.textContent = 'No cards';
        cardSubtitle.textContent = '';
        cardPrompt.textContent = 'Try a different filter.';
        cardQuote.textContent = '';
        currentPromptEl.textContent = '';
        return;
      }

      const card = filteredCards[currentIndex];
      const review = reviews[card.id] || {};

      let cardClass = `card ${card.type}`;
      if (card.subtype) cardClass += ` ${card.subtype}`;
      cardElement.className = cardClass;

      const imageFolder = selectedVersions[card.id] || 'cards';
      cardImage.src = `${imageFolder}/${card.id}.png`;
      cardImage.alt = card.title;
      cardCategory.textContent = card.category;
      cardTitle.textContent = card.title;
      cardSubtitle.textContent = card.subtitle;
      cardPrompt.textContent = card.prompt;
      cardQuote.textContent = card.quote;

      const fullPrompt = `${BASE_STYLE}, ${card.imagePrompt}`;
      currentPromptEl.textContent = fullPrompt;
      // Show user's edit if saved, otherwise show the suggested revised prompt
      revisedPromptEl.value = review.revisedPrompt || (card.revisedPrompt ? `${BASE_STYLE}, ${card.revisedPrompt}` : '');
      commentInput.value = review.comment || '';

      document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.rating === review.rating);
      });

      const progress = ((currentIndex + 1) / filteredCards.length) * 100;
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `Card ${currentIndex + 1} of ${filteredCards.length}`;

      prevBtn.disabled = currentIndex === 0;
      nextBtn.textContent = currentIndex === filteredCards.length - 1 ? 'Finish' : 'Next ‚Üí';

      updateSummary();
    }

    function saveReview(rating) {
      const card = filteredCards[currentIndex];
      if (!reviews[card.id]) reviews[card.id] = {};
      reviews[card.id].rating = rating;
      reviews[card.id].comment = commentInput.value;
      reviews[card.id].revisedPrompt = revisedPromptEl.value;
      reviews[card.id].timestamp = new Date().toISOString();
      localStorage.setItem('alchemyDeckReviews', JSON.stringify(reviews));
      updateDisplay();
      updateFilterCounts();
    }

    function saveInputs() {
      const card = filteredCards[currentIndex];
      if (!reviews[card.id]) reviews[card.id] = {};
      reviews[card.id].comment = commentInput.value;
      reviews[card.id].revisedPrompt = revisedPromptEl.value;
      localStorage.setItem('alchemyDeckReviews', JSON.stringify(reviews));
    }

    function updateSummary() {
      const reviewedCount = Object.keys(reviews).filter(k => reviews[k].rating).length;
      if (reviewedCount > 0) {
        summarySection.style.display = 'block';
        document.getElementById('goodCount').textContent = Object.values(reviews).filter(r => r.rating === 'up').length;
        document.getElementById('mehCount').textContent = Object.values(reviews).filter(r => r.rating === 'meh').length;
        document.getElementById('badCount').textContent = Object.values(reviews).filter(r => r.rating === 'down').length;
      }
    }

    function exportReviews() {
      const exportData = {
        exported: new Date().toISOString(),
        baseStyle: BASE_STYLE,
        summary: {
          total: cards.length,
          approved: Object.values(reviews).filter(r => r.rating === 'up').length,
          needsWork: Object.values(reviews).filter(r => r.rating === 'meh').length,
          rejected: Object.values(reviews).filter(r => r.rating === 'down').length,
          unreviewed: cards.filter(c => !reviews[c.id]?.rating).length
        },
        cards: cards.map(card => ({
          ...card,
          fullPrompt: `${BASE_STYLE}, ${card.imagePrompt}`,
          review: reviews[card.id] || { rating: null, comment: '', revisedPrompt: '' }
        }))
      };
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `alchemy-deck-review-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    async function submitToGoogleSheets() {
      const statusEl = document.getElementById('submitStatus');
      const reviewerName = document.getElementById('reviewerName').value.trim();

      if (!reviewerName) {
        statusEl.style.color = '#f87171';
        statusEl.textContent = 'Please enter your name first.';
        return;
      }

      if (GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID_HERE')) {
        statusEl.style.color = '#f87171';
        statusEl.textContent = 'Google Script URL not configured. See google-apps-script.js for setup.';
        return;
      }

      const reviewedCount = Object.keys(reviews).filter(k => reviews[k].rating).length;
      if (reviewedCount === 0) {
        statusEl.style.color = '#f87171';
        statusEl.textContent = 'Please review at least one card before submitting.';
        return;
      }

      statusEl.style.color = '#fbbf24';
      statusEl.textContent = 'Submitting...';

      const submitData = {
        reviewer: reviewerName,
        submitted: new Date().toISOString(),
        summary: {
          total: cards.length,
          approved: Object.values(reviews).filter(r => r.rating === 'up').length,
          needsWork: Object.values(reviews).filter(r => r.rating === 'meh').length,
          rejected: Object.values(reviews).filter(r => r.rating === 'down').length,
          unreviewed: cards.filter(c => !reviews[c.id]?.rating).length
        },
        reviews: reviews
      };

      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Required for Google Apps Script
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submitData)
        });

        // no-cors means we can't read the response, but if it didn't throw, it likely worked
        statusEl.style.color = '#4ade80';
        statusEl.textContent = `Submitted! Thank you, ${reviewerName}.`;

        // Save the name for next time
        localStorage.setItem('alchemyDeckReviewerName', reviewerName);
      } catch (error) {
        statusEl.style.color = '#f87171';
        statusEl.textContent = 'Error submitting. Please try again or export JSON instead.';
        console.error('Submit error:', error);
      }
    }

    // Restore saved reviewer name
    const savedName = localStorage.getItem('alchemyDeckReviewerName');
    if (savedName) document.getElementById('reviewerName').value = savedName;

    document.querySelectorAll('.rating-btn').forEach(btn => btn.addEventListener('click', () => saveReview(btn.dataset.rating)));
    document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => applyFilter(btn.dataset.filter)));
    commentInput.addEventListener('blur', saveInputs);
    revisedPromptEl.addEventListener('blur', saveInputs);
    prevBtn.addEventListener('click', () => { saveInputs(); if (currentIndex > 0) { currentIndex--; updateDisplay(); } });
    nextBtn.addEventListener('click', () => { saveInputs(); if (currentIndex < filteredCards.length - 1) { currentIndex++; updateDisplay(); } });
    document.getElementById('exportBtn').addEventListener('click', exportReviews);
    document.getElementById('submitBtn').addEventListener('click', submitToGoogleSheets);

    document.addEventListener('keydown', (e) => {
      if (e.target === commentInput || e.target === revisedPromptEl) return;
      if (e.key === 'ArrowLeft' && currentIndex > 0) { saveInputs(); currentIndex--; updateDisplay(); }
      else if (e.key === 'ArrowRight' && currentIndex < filteredCards.length - 1) { saveInputs(); currentIndex++; updateDisplay(); }
      else if (e.key === '1') saveReview('up');
      else if (e.key === '2') saveReview('meh');
      else if (e.key === '3') saveReview('down');
    });

    updateDisplay();
    updateFilterCounts();
  </script>
</body>
</html>
